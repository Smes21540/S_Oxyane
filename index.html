<!DOCTYPE html>
<html lang="fr">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YG4RV4W27S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YG4RV4W27S');
</script>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S√©choirs</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåΩ</text></svg>">


<!-- D√©pendances -->
<script src="libs/jszip.min.js"></script>
<script src="libs/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<style>
:root{
  --bg:#fff5f5;
  --panel:#ffffff;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --overlay:rgba(0,0,0,0.8);
  --table-border:#eee;
  --thumb-border:#ccc;

  /* Th√®me (orange par d√©faut) */
  --accent:#ff7043;
  --accent-contrast:#fff;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;

  /* Couleurs des lignes du tableau */
  --row-even:#ffe5d9;
  --row-odd:#fff5f5;
}

*{box-sizing:border-box}

body{
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  background:var(--bg);color:var(--text);margin:0;padding:0;
  display:flex;height:100vh;overflow:hidden;
}

/* Alerte r√©seau */
#netAlert{
  display:none;position:fixed;top:0;left:0;right:0;z-index:3000;
  background:var(--accent-muted);color:var(--danger);
  padding:8px;text-align:center;font-weight:bold;
}

/* Sidebar */
#sidebar{
  background:var(--sidebar-bg);border-right:2px solid var(--accent);
  padding:20px 10px;overflow-y:auto;z-index:1000;
  width:auto;min-width:200px;max-width:500px;
}
#sidebar h2{
  color:var(--accent);font-size:18px;font-weight:bold;text-transform:uppercase;
  margin:0 0 12px 0;padding-left:5px;display:flex;align-items:center;gap:6px;
}
#folderTree ul{list-style:none;padding-left:20px;margin:0;}
#folderTree li{cursor:pointer;margin:5px 0;}
.folder-toggle{font-weight:bold;margin-right:5px;cursor:pointer;color:var(--accent);}
.folder-name{cursor:pointer;}
.active-folder {
  background: var(--accent-muted);
  border-radius: 3px;
  padding: 1px 4px;
  font-weight: 600;
  color: var(--accent-darker);
  box-shadow: none;
}



/* Main */
#main{flex:1;padding:10px 20px;display:flex;flex-direction:column;overflow:hidden;}
.header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:15px;}
.header .logo{height:60px;width:auto;}
#fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
#fileName,#lineCount{color:var(--danger);}
#fileName{font-size:20px;font-weight:bold;white-space:nowrap;max-width:250px;overflow:hidden;text-overflow:ellipsis;display:none;}
#lineCount{font-size:12px;display:none;}

/* Contr√¥les */
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
.controls button{
  background:var(--accent);color:var(--accent-contrast);
  border:none;cursor:pointer;font-weight:bold;
  padding:6px 12px;border-radius:6px;font-size:13px;transition:0.3s;
}
.controls button:hover{background:var(--accent-darker);transform:scale(1.05);}

/* --- Champs date modernis√©s --- */
.date-field {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--panel);
  border: 2px solid var(--table-border);
  border-radius: 8px;
  padding: 6px 10px;
  transition: all 0.3s ease;
}

/* üìÖ Ic√¥ne calendrier plus grande et cliquable */
.date-field span {
  font-size: 24px; /* plus visible */
  color: var(--accent);
  cursor: pointer;
  user-select: none;
  transition: transform 0.2s, color 0.2s;
}
.date-field span:hover {
  transform: scale(1.2);
  color: var(--accent-darker);
}

/* Masque le champ tant qu‚Äôaucune date n‚Äôest choisie */
/* Flatpickr remplace les inputs type="date" par .flatpickr-input */
.date-field .flatpickr-input {
  display: none;
  border: none;
  outline: none;
  background: transparent;
  font-size: 15px;
  color: var(--text);
  padding: 6px 2px;
}
.date-field.has-date .flatpickr-input {
  display: inline-block;
}


input[type="date"]::-webkit-calendar-picker-indicator {
  display: none;
  -webkit-appearance: none;
}

/* --- Style √©quilibr√© du calendrier Flatpickr --- */
.flatpickr-calendar {
  font-size: 1em !important;          /* ‚úÖ police normale (plus de chevauchement) */
  transform: scale(1.15);             /* ‚úÖ zoom global du calendrier (plus grand sans grossir le texte) */
  transform-origin: top left;         /* garde l‚Äôouverture propre pr√®s de l‚Äôic√¥ne */
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  border-radius: 12px;
  z-index: 3000 !important;
}

.flatpickr-day {
  width: 2.4em !important;
  height: 2.4em !important;
  line-height: 2.4em !important;
  font-size: 0.95em !important;       /* ‚úÖ jours un peu plus petits, lisibles */
  font-weight: 500;
}

.flatpickr-months .flatpickr-month {
  font-size: 1em;                     /* ‚úÖ mois et navigation lisibles mais pas √©normes */
  font-weight: bold;
}

.flatpickr-weekday {
  font-size: 0.85em;                  /* ‚úÖ noms des jours ajust√©s */
  color: var(--accent-darker);
  font-weight: 600;
}




/* Tableau */
#tableWrapper{flex:1;overflow:auto;}
#tableContainer{overflow:auto;border-radius:8px;box-shadow:0 4px 12px var(--shadow);background:var(--panel);}
table{border-collapse:separate;border-spacing:0;width:100%;font-size:13px;}
thead th,tbody td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);white-space:nowrap;}
thead th{
  position:sticky;top:0;z-index:2;background:var(--accent);
  color:var(--accent-contrast);font-weight:bold;text-transform:uppercase;cursor:pointer;
}
tbody tr:nth-child(even){background:var(--row-even);}
tbody tr:nth-child(odd){background:var(--row-odd);}
tbody tr:hover{background:var(--accent-muted);}
.sort-arrow{margin-left:5px;font-size:11px;color:var(--accent-contrast);}

/* Cellule actions + boutons survol */
td.action-cell{display:flex;align-items:center;gap:8px;}
.action-btn{
  background:var(--accent);color:var(--accent-contrast);border:none;cursor:pointer;
  font-weight:bold;padding:6px 12px;border-radius:6px;font-size:12px;transition:0.2s;
  margin-right:6px;opacity:0;visibility:hidden;
}
tbody tr:hover .action-btn{opacity:1;visibility:visible;}
.action-btn:hover{background:var(--accent-darker);transform:scale(1.05);}

/* Miniatures JPG */
#csvTable td img{
  max-width:120px;
  cursor:pointer;border-radius:6px;border:1px solid var(--thumb-border);
  transition:transform 0.2s,box-shadow 0.2s;margin-right:6px;
}
#csvTable td img:hover{transform:scale(1.08);box-shadow:0 0 8px var(--shadow);}

/* Fl√®che anim√©e */
@keyframes bounceLeft {0%,100% { transform: translateX(0);}50% { transform: translateX(-8px);} }
.arrow-hint {display:inline-block;margin-right:8px;color:var(--accent-darker);
  font-size:22px;animation:bounceLeft 1s infinite;}

/* Spinner */
#spinner{
  display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:40px;height:40px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;
}

/* Modale images */
.modal{
  display:none;                 /* ‚úÖ ferm√©e par d√©faut */
  position:fixed;
  z-index:1300;
  inset:0;                      /* ‚úÖ remplace left/top/width/height */
  background-color:var(--overlay);

  /* ‚úÖ centrage via flex */
  justify-content:center;
  align-items:center;
  flex-direction:column;

  padding:20px;
  box-sizing:border-box;
}

.modal .close{
  position:absolute;
  top:15px;
  right:25px;
  color:#fff;
  font-size:30px;
  cursor:pointer;
}

.modal iframe{
  width:min(90vw, 1200px);
  height:80vh;
  border:none;
  border-radius:10px;
  background:#000;
}

#modalVideo{
  width:min(90vw, 1200px);
  height:80vh;
  border:none;
  border-radius:10px;
  background:#000;
}

#modalImg{
  display:block;
  max-width:min(90vw, 1200px);
  max-height:80vh;
  border-radius:10px;
  background:#000;
  object-fit:contain;
}

.modal-actions{margin-top:15px;display:flex;justify-content:center;gap:10px;}
.modal-actions button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:bold;}
.modal-actions button:hover{background:var(--accent-darker);}


/* Overlay ZIP */
#zipOverlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);z-index:1400;justify-content:center;align-items:center;
}
#zipBox{
  background:var(--accent-muted);color:var(--text);padding:20px 25px;border-radius:12px;
  text-align:center;width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.3);position:relative;
}
#zipBox h2{margin:0 0 10px 0;color:var(--accent);font-size:18px;}
#zipFileName{font-size:13px;margin-bottom:15px;color:var(--muted-text);word-break:break-word;}
#zipProgressBar{width:100%;height:22px;background:#eee;border-radius:11px;overflow:hidden;}
#zipProgress{
  height:100%;width:0;background:var(--accent);transition:width 0.3s;
  display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:13px;
}
#zipCounter{margin-top:10px;font-size:12px;color:var(--text);}
#zipTime{margin-top:5px;font-size:12px;color:var(--muted-text);}
#zipClose{
  position:absolute;top:8px;right:12px;font-size:18px;font-weight:bold;color:var(--accent);cursor:pointer;
}
#zipClose:hover{color:var(--accent-darker);}

/* Menu secret (th√®mes) */
#secretBtn {
  position: fixed;bottom: 10px;right: 10px;width: 25px;height: 25px;
  opacity: 0;cursor: pointer;z-index: 2000;
}
#themeMenu {
  display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;
}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {
  display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;
  background: var(--accent);color: var(--accent-contrast);cursor:pointer;font-size:13px;
}
#themeMenu button:hover {background: var(--accent-darker);}
.flame {
  display: inline-flex;          /* üîÑ pour √™tre sur la m√™me ligne que üìù */
  justify-content: center;
  align-items: center;
  font-size: 20px;               /* taille harmonis√©e */
  line-height: 1;
  vertical-align: middle;
  animation: flicker 0.6s infinite alternate,
             sway 1.2s infinite ease-in-out;
  text-shadow:
    0 0 4px rgba(255, 140, 0, 0.8),
    0 0 8px rgba(255, 80, 0, 0.7),
    0 0 12px rgba(255, 30, 0, 0.5);
}


/* Petite flamme pour les dossiers dans l‚Äôarborescence */
.flame-folder {
  display: inline;               
  font-size: 14px;               
  margin-right: 1px;             
  line-height: 1;                
  vertical-align: middle;
  text-shadow: 
    0 0 3px rgba(255, 140, 0, 0.8),
    0 0 6px rgba(255, 80, 0, 0.7);
  animation: flicker 1s infinite alternate;
  margin-right: 4px;
}

.note {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;               /* m√™me taille que üî• */
  vertical-align: middle;
  margin-left: 4px;              /* petit espace entre üî• et üìù */
  color: #1565c0;                /* bleu lisible */
  text-shadow: 0 0 4px rgba(21, 101, 192, 0.5);
}


@keyframes sway {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(3px) rotate(3deg); }
}


#eventAlert {
  display:none;
  position:fixed;
  top:40px; /* juste sous netAlert */
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  color:#fff;
  padding:8px 16px;
  border-radius:6px;
  font-weight:bold;
  z-index:3000;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}

/* === Bouton Gaz (toujours visible, jaune) === */
.gaz-btn {
  background: linear-gradient(180deg, #ffd54f, #ffb300);
  color: fcdc12;
  border: none;
  font-weight: bold;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  margin-right: 6px;
  cursor: default;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  opacity: 1 !important;
  visibility: visible !important;
}

.gaz-btn:nth-of-type(2) {
  background: linear-gradient(180deg, #bbdefb, #64b5f6); /* bleu clair */
  color: #0d47a1;
}

/* Conteneur des boutons gaz */
.gaz-group {
  display: flex;
  justify-content: center;   /* centrage horizontal */
  align-items: center;       /* centrage vertical */
  gap: 12px;                 /* espace entre les deux boutons */
  width: 100%;
}

/* Style g√©n√©ral des boutons gaz */
.gaz-btn {
  background: linear-gradient(180deg, #ffd54f, #ffb300);
  color: #5d4037;
  border: none;
  font-weight: bold;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 14px;
  cursor: default;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  opacity: 1 !important;
  visibility: visible !important;
  text-align: center;
  transition: transform 0.3s ease, background 0.3s ease;
  min-width: 110px;          /* largeur fixe pour un alignement parfait */
}

/* 3e bouton = Temps = bleu clair */
.gaz-group .gaz-btn:nth-of-type(3) {
  background: linear-gradient(180deg, #bbdefb, #64b5f6);
  color: #0d47a1;
}


/* --- Jours chauds dans le calendrier --- */
.hot-day {
  background: var(--accent-muted) !important;
  color: var(--danger) !important;
  border-radius: 50% !important;
  font-weight: bold !important;
  box-shadow: 0 0 6px rgba(255, 100, 0, 0.6);
}


/* Cache le bloc de filtres de date tant qu‚Äôaucun dossier n‚Äôest s√©lectionn√© */
.controls {
  display: none;
}


/* === STRUCTURE DE L'ARBORESCENCE === */

/* üî• Flamme ou ic√¥ne √† gauche, sans d√©caler le nom */
.folder-name {
  position: relative;
  display: inline-block;
  cursor: pointer;
  user-select: none;
  font-weight: 500;
}

/* ‚úÖ Supprime compl√®tement les points devant les dossiers */
#folderTree li {
  list-style-type: none;
}

.flame-folder {
  position: absolute;
  left: -18px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  text-shadow:
    0 0 3px rgba(255, 140, 0, 0.8),
    0 0 6px rgba(255, 80, 0, 0.7);
  animation: flicker 1s infinite alternate;
  pointer-events: none;
}

/* üüß Cadre visuel du dossier actif */
.active-folder {
  background: var(--accent-muted);
  border-left: 1px solid var(--accent);
  border-radius: 4px;
  padding: 2px 6px;
  font-weight: 600;
  color: var(--accent-darker);
  display: inline-block;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
}

/* üìÇ Hi√©rarchie : indentation et ligne verticale */
#folderTree ul ul {
  margin-left: 46px;
  border-left: 2px solid var(--accent-muted);
  padding-left: 14px;
}

#folderTree li {
  position: relative;
  margin: 3px 0;
}

#folderTree li::before {
  content: "";
  position: absolute;
  left: -10px;
  top: 0;
  bottom: 0;
  border-left: 1px dashed var(--accent-muted);
  opacity: 0.4;
}


.gaz-summary {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  margin-left: 20px;
}

.gaz-total {
  padding: 5px 12px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  color: #3e2723;
}

.gaz-total-m3 {
  background: linear-gradient(180deg, #fff59d, #fbc02d);
}

.gaz-total-kwh {
  background: linear-gradient(180deg, #ffd54f, #ffb300);
}





/* === Fond illustration SMES attach√©e √† la sidebar === */
#sidebar {
  position: relative;
  overflow: hidden;
}

#smes-footer-bg {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 35vh;

  background: url("img/smes_footer.png") left bottom no-repeat;
  background-size: cover; /* image adapt√©e √† l‚Äôespace */
  pointer-events: none;

  mask-image: linear-gradient(
      to top,
      rgba(0,0,0,1) 80%,
      rgba(0,0,0,0) 100%
  );
  -webkit-mask-image: linear-gradient(
      to top,
      rgba(0,0,0,1) 80%,
      rgba(0,0,0,0) 100%);
}

/* --- image affich√©e UNIQUEMENT si th√®me orange --- */
#smes-footer-bg {
  display: none;
}

body[data-theme="orange"] #smes-footer-bg {
  display: block;
}







  
  

</style>

<!-- Calendrier enrichi -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>



</head>
<body>

<div id="netAlert">‚ö†Ô∏è Pas de connexion internet d√©tect√©e. V√©rifiez votre r√©seau.</div>
<div id="eventAlert">‚úÖ √âv√©nements charg√©s</div>
<div id="spinner"></div>


<!-- Sidebar dossiers -->
<div id="sidebar">
  <div id="smes-footer-bg"></div>
  <h2><span>üåΩ</span>Sites / S√©choirs</h2>
  <ul id="folderTree"></ul>
</div>


<!-- Main -->
<div id="main">
  <div class="header">
    <img src="img/logo.png" class="logo" id="mainLogo" alt="Logo"/>
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <div class="controls">
    Filtrer par date : 
    <div class="date-field"><span id="iconStart">üìÖ</span><input type="date" id="startDate"></div>
    √†
    <div class="date-field"><span id="iconEnd">üìÖ</span><input type="date" id="endDate"></div>
    <button onclick="applyFilter()">Filtrer</button>
    <button onclick="clearFilter()">Tout afficher</button>
    <button id="downloadFolderBtn">T√©l√©charger le dossier</button>
<button id="exportCsvBtn" style="display:none;" title="Voir les barres graphiques de consommation par jour">Graphique</button>
<button id="exportExcelGazBtn" style="display:none;" title="Exporter les donn√©es en Excel (kWh, m¬≥, dur√©e, tonnage)">Export Excel</button>






    

  </div>

  <div id="tableWrapper">
    <div id="tableContainer">
      <table id="csvTable">
<thead>
  <tr>
    <th onclick="sortTable(0,'date')">Date <span class="sort-arrow"></span></th>
    <th style="width:40px; text-align:center;"></th>

    <th>T√©l√©charger / Ouvrir</th>
    <th>Nom du fichier</th>
    <th>Dossier</th>
    <th onclick="sortTable(5,'number')">Taille <span class="sort-arrow"></span></th>
  </tr>
</thead>


        <tbody>
          <tr>
            <td colspan="5" style="text-align:left;">
              <span class="arrow-hint">‚¨Ö</span> S√©lectionner un dossier...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modale image -->
<div id="imageModal" class="modal" role="dialog" aria-modal="true">
  <span class="close" onclick="closeModal()" aria-label="Fermer">&times;</span>
  <!-- tabindex=-1 pour √©viter que l'iframe vole le focus / bloque les fl√®ches -->
<iframe id="modalFrame" tabindex="-1"></iframe>

<video id="modalVideo"
       controls
       style="display:none; width:90%; height:80vh; border:none; border-radius:10px; background:#000;">
</video>

<img id="modalImg"
     style="display:none; max-width:90%; max-height:80vh; border-radius:10px; background:#000;"
     alt="Aper√ßu" />


<div class="modal-actions">
  <button id="prevBtn">&larr; Pr√©c√©dent</button>
  <button id="nextBtn">Suivant &rarr;</button>
  <button id="downloadBtn">T√©l√©charger</button>
</div>

</div>

<!-- Overlay ZIP -->
<div id="zipOverlay">
  <div id="zipBox">
    <span id="zipClose">&times;</span>
    <h2>Pr√©paration du ZIP...</h2>
    <div id="zipFileName"></div>
    <div id="zipProgressBar"><div id="zipProgress">0%</div></div>
    <div id="zipCounter">0 / 0 fichiers</div>
    <div id="zipTime">Temps restant : --</div>
  </div>
</div>

<!-- Bouton secret + menu th√®mes -->
<div id="secretBtn" title=" "></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script>
/* ----------- Config Drive ----------- */
const ROOT_FOLDER_ID="18QkQPyCZxTCAaoz_qd1wAelmQbSE4ex8";
// ‚úÖ Active/d√©sactive les calculs de consommation gaz
const ENABLE_GAZ_CALC = true;  // ‚Üê passe √† false pour d√©sactiver

// === Dictionnaire global des notes ===
// storedNotes["YYYYMMDD"] = [ "txt1", "txt2", ... ]
let storedNotes = {};




/* ----------- Config personnalis√©e ----------- */
const FLAME_THRESHOLD = 40.0;   // seuil d√©clencheur de la flamme üî•

/* ----------- √âtat ----------- */
let previewFiles = [], currentPreviewIndex = 0;
let filterStartDate="", filterEndDate="";
let themeMenuTimer;
let cancelScan = false; // üõë permet d‚Äôarr√™ter le scan si on clique ailleurs

async function getTonnageForDate(siteRoot, dateStr) {

    console.log("=== TONNAGE DEBUG ===");
    console.log("Site :", siteRoot);
    console.log("Date :", dateStr);

    try {
        // On r√©cup√®re le chemin complet actuel
const path = (localStorage.getItem("lastFolderPath") || "").split("/");

// Exemple : ["Valbonne","Consommation Gaz"]
// On prend la racine du site : "Valbonne"
const siteName = path[0];

// On liste les dossiers au niveau du site
const root = await fetchFolderContents(ROOT_FOLDER_ID);  // l‚ÄôID Drive de ton dossier principal

// On trouve le dossier du site
const siteFolder = root.find(f => f.name === siteName);

if (!siteFolder) {
    console.warn("‚ùå Impossible de trouver le dossier du site :", siteName);
    return 0;
}

// Maintenant on scanne les sous-dossiers du site
const folders = await fetchFolderContents(siteFolder.id);


        const tracatemp = folders.find(f =>
            f.mimeType === "application/vnd.google-apps.folder" &&
            f.name.toLowerCase().includes("tra√ßa_temp")
        );

        if (!tracatemp) {
            console.warn("‚ùå Dossier Tra√ßa_Temp introuvable !");
            return 0;
        }

        console.log("‚úî Dossier Tra√ßa_Temp trouv√© :", tracatemp.name, tracatemp.id);

        const files = await fetchFolderContents(tracatemp.id);

        const csvName = `SA00094_${dateStr.replace(/-/g, "")}.csv`;

        console.log("Recherche du fichier :", csvName);

        const file = files.find(f => f.name.toLowerCase() === csvName.toLowerCase());

        if (!file) {
            console.warn("‚ùå Fichier non trouv√© dans Tra√ßa_Temp :", csvName);
            return 0;
        }

        console.log("‚úî Fichier trouv√© :", file.name, file.id);

        // T√©l√©chargement du CSV
        const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${file.id}&name=${encodeURIComponent(file.name)}&site=Smes_Acces`;

        console.log("T√©l√©chargement depuis :", url);

        const resp = await fetch(url);

        if (!resp.ok) {
            console.error("‚ùå Erreur t√©l√©chargement CSV :", resp.status);
            return 0;
        }

        const text = await resp.text();

        console.log("‚úî CSV t√©l√©charg√©, longueur :", text.length);

        const lines = text.trim().split(/\r?\n/);

        console.log("Nombre de lignes :", lines.length);

        // === Nouveau parseur fiable ===
        function parseCSV(line) {
            const result = [];
            let current = "";
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const c = line[i];

                if (c === '"' && line[i + 1] === '"') {
                    current += '"';
                    i++;
                }
                else if (c === '"') {
                    insideQuotes = !insideQuotes;
                }
                else if (c === "," && !insideQuotes) {
                    result.push(current);
                    current = "";
                }
                else {
                    current += c;
                }
            }
            result.push(current);
            return result;
        }

        const header = parseCSV(lines[0]);

        console.log("Header :", header);

        const idx = header.indexOf("Cumul (tonnes)");

        console.log("Index 'Cumul (tonnes)' :", idx);

        if (idx === -1) {
            console.warn("‚ùå Colonne 'Cumul (tonnes)' introuvable !");
            return 0;
        }

        const firstLine = parseCSV(lines[1]);
        const lastLine  = parseCSV(lines[lines.length - 1]);

        console.log("Premi√®re ligne tonnage brute :", firstLine[idx]);
        console.log("Derni√®re ligne tonnage brute :", lastLine[idx]);

        const first = parseFloat(firstLine[idx].replace(",", "."));
        const last  = parseFloat(lastLine[idx].replace(",", "."));

        console.log("Parsed first =", first, "last =", last);

        if (!isFinite(first) || !isFinite(last)) {
            console.warn("‚ùå Valeurs tonnage invalides !");
            return 0;
        }

        const diff = last - first;

        console.log("‚úî Tonnage calcul√© =", diff);

        return diff;

    } catch (e) {
        console.error("üí• Exception tonnage :", e);
        return 0;
    }
}




/* ----------- Utilitaires UI ----------- */
const spinner=document.getElementById('spinner');
function showSpinner(){spinner.style.display='block';}
function hideSpinner(){spinner.style.display='none';}

function updateNetworkStatus(){
  document.getElementById("netAlert").style.display = navigator.onLine ? "none" : "block";
}
window.addEventListener("online",updateNetworkStatus);
window.addEventListener("offline",updateNetworkStatus);

function formatSize(bytes){
  if(!bytes) return "?";
  const units=["o","Ko","Mo","Go"]; let i=0; let v=Number(bytes);
  while(v>=1024 && i<units.length-1){ v/=1024; i++; }
  return (i===0?Math.round(v):v.toFixed(1))+" "+units[i];
}

function showEventAlert(msg="‚úÖ √âv√©nements charg√©s") {
  const alertBox = document.getElementById("eventAlert");
  alertBox.textContent = msg;
  alertBox.style.display = "block";
  setTimeout(()=>{ alertBox.style.display="none"; },2000);
}


/* ----------- Drive API ----------- */
async function fetchFolderContents(folderId){
  if(!navigator.onLine){updateNetworkStatus();return [];}
  showSpinner();
  try{
    const res = await fetch(`https://smes21540.netlify.app/.netlify/functions/drive?list=true&id=${folderId}&site=Smes_Acces`);

    // üö´ Blocage abonnement
    if (res.status === 403) {
      alert("‚õî Acc√®s suspendu : merci de r√©gulariser votre abonnement.");
      hideSpinner();
      return [];
    }

    // üîé Autre erreur HTTP
    if (!res.ok) {
      console.error("Erreur proxy Drive:", res.status, res.statusText);
      alert("Erreur r√©seau ou proxy. V√©rifie ta connexion ou ton acc√®s.");
      hideSpinner();
      return [];
    }

    // ‚úÖ Lecture JSON si tout va bien
    const data = await res.json();
    if (data.error) {
      console.error("Erreur Google Drive API:", data.error);
      alert("Erreur Drive (proxy). Ouvre la console pour le d√©tail.");
      hideSpinner();
      return [];
    }

    return data.files || [];

  } catch(e){
    console.error("Erreur Drive:", e);
    alert("Erreur interne ou blocage d‚Äôacc√®s (proxy).");
    return [];
  } finally{
    hideSpinner();
  }
}




async function loadRootFolders(){
  const files = await fetchFolderContents(ROOT_FOLDER_ID);
  const rootUL = document.getElementById('folderTree');
  rootUL.innerHTML = '';

// üîí Cacher les filtres quand on revient √† la racine
document.querySelector(".controls").style.display = "none";


  files
  .filter(f => f.mimeType === 'application/vnd.google-apps.folder')
  .sort((a,b) => a.name.localeCompare(b.name, 'fr', { sensitivity:'base' }))
  .forEach(f => {

    const li = document.createElement('li'); 
    li.dataset.id = f.id;

    const toggle = document.createElement('span'); 
    toggle.className = 'folder-toggle'; 
    toggle.textContent = '';
    toggle.onclick = () => toggleFolder(li);

const span = document.createElement('span');
span.className = 'folder-name';

const lowerName = f.name.toLowerCase();

if (lowerName.includes("gaz")) {
  span.innerHTML = `‚õΩ ${f.name}`;
} else if (lowerName.includes("echantillonnage")) {
  span.innerHTML = `üìñ ${f.name}`;
} else if (lowerName.includes("capture")) {
  span.innerHTML = `üñºÔ∏è ${f.name}`;
} else if (lowerName.includes("rapport")) {
  span.innerHTML = `üìÑ ${f.name}`;
} else if (lowerName.includes("historique")) {
  span.innerHTML = `üóÇÔ∏è ${f.name}`;
} else if (lowerName.includes("tra√ßa_temp") || lowerName.includes("traca_temp")) {
  span.innerHTML = `üìà ${f.name}`;
} else {
  span.textContent = f.name;
}




span.onclick = (e) => loadFolderFilesOnClick(li, e);





    li.appendChild(toggle); 
    li.appendChild(span); 
    rootUL.appendChild(li);
  });

  // üî• V√©rifier automatiquement deux crans plus bas sans ouvrir visuellement
  setTimeout(async () => {
    const siteFolders = document.querySelectorAll("#folderTree > li");

    for (const siteLi of siteFolders) {
      const subFolders = await fetchChildren(siteLi.dataset.id);
      for (const sub of subFolders) {
        if (sub.name.includes("Temp")) {
          await checkTra√ßaTempToday(siteLi, sub.id); 
        }
      }
    }
  }, 1000);
}

async function toggleFolder(li){
  const toggle=li.querySelector('.folder-toggle');
if(li.dataset.loaded==='true'){
  const ul = li.querySelector('ul');
  // ‚úÖ Ne replie pas le parent si on clique un sous-dossier
  if (!ul) return;
  if (event && event.target && !event.target.classList.contains('folder-name')) return;
  ul.style.display = ul.style.display === 'none' ? 'block' : 'none';
  return;
}

  toggle.textContent='‚Ä¶';
  const files=await fetchFolderContents(li.dataset.id);
  const ul=document.createElement('ul');
  const folders = files
  .filter(f => f.mimeType === 'application/vnd.google-apps.folder')
  .sort((a,b) => a.name.localeCompare(b.name, 'fr', { sensitivity:'base' }));

for (const f of folders) {

    const childLi=document.createElement('li'); 
    childLi.dataset.id=f.id;

    const childToggle=document.createElement('span'); 
    childToggle.className='folder-toggle'; 
    childToggle.textContent='';
    childToggle.onclick=()=>toggleFolder(childLi);

const span = document.createElement('span');
span.className = 'folder-name';

const lowerName = f.name.toLowerCase();

if (lowerName.includes("gaz")) {
  span.innerHTML = `‚õΩ ${f.name}`;
} else if (lowerName.includes("echantillonnage")) {
  span.innerHTML = `üìñ ${f.name}`;
} else if (lowerName.includes("capture")) {
  span.innerHTML = `üñºÔ∏è ${f.name}`;
} else if (lowerName.includes("rapport")) {
  span.innerHTML = `üìÑ ${f.name}`;
} else if (lowerName.includes("historique")) {
  span.innerHTML = `üóÇÔ∏è ${f.name}`;
} else if (lowerName.includes("tra√ßa_temp") || lowerName.includes("traca_temp")) {
  span.innerHTML = `üìà ${f.name}`;
} else {
  span.textContent = f.name;
}



span.onclick = (e) => loadFolderFilesOnClick(childLi, e);



    childLi.appendChild(childToggle); 
    childLi.appendChild(span); 
    ul.appendChild(childLi);

    // ‚úÖ Cas sp√©cial : si le dossier est Tra√ßa_Temp ‚Üí pr√©charger Historique
    if (f.name.toLowerCase().includes("tra√ßa_temp") || f.name.toLowerCase().includes("traca_temp")) {
      const siblings = await fetchFolderContents(li.dataset.id);
      const hist = siblings.find(s => s.mimeType === 'application/vnd.google-apps.folder' && s.name.toLowerCase().includes("historique"));
      if (hist) {
        const histFiles = await fetchFolderContents(hist.id);
        const z3Files = histFiles.filter(ff => ff.name.toUpperCase().startsWith("Z3") && ff.name.toLowerCase().endsWith(".csv"));
localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
console.log("[Z3] Pr√©charg√©s depuis Historique:", z3Files.length);
showEventAlert();

      }
    }

    // ‚úÖ V√©rif Temp (flamme üî•)
    if(f.name.includes("Temp")){ checkTra√ßaTempToday(li, f.id); }
  }
  li.appendChild(ul); 
  li.dataset.loaded='true'; 
  toggle.textContent='';
}


// Fonction utilitaire pour r√©cup√©rer les sous-dossiers sans modifier l'affichage
async function fetchChildren(folderId){
  const files = await fetchFolderContents(folderId);
  return files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
}

async function loadFolderFilesOnClick(li, event){
  // reset des notes
  storedNotes = {};
  if (typeof jsonDates !== "undefined") jsonDates.clear?.();
  localStorage.removeItem("csvNotes");

  await toggleFolder(li);

// üîÑ R√©initialiser la s√©lection visuelle
document.querySelectorAll('#folderTree li span.folder-name').forEach(s => s.classList.remove('active-folder'));

// ‚úÖ Surligne le dossier cliqu√©
const nameSpan = li.querySelector('span.folder-name');
if (nameSpan) nameSpan.classList.add('active-folder');

// ‚úÖ Surligne aussi tous les parents (chemin hi√©rarchique)
let parentLi = li.parentElement.closest('li');
while (parentLi) {
  const parentSpan = parentLi.querySelector('span.folder-name');
  if (parentSpan) parentSpan.classList.add('active-folder');
  parentLi = parentLi.parentElement.closest('li');
}

  localStorage.setItem('lastFolderId', li.dataset.id);

// üìÇ Sauvegarde du chemin complet (ex: Voreppe/Tra√ßa_Temp)
function buildFullFolderPath(li) {
  const parts = [];
  let current = li;
  while (current) {
    const nameSpan = current.querySelector(".folder-name");
    if (nameSpan) parts.unshift(nameSpan.textContent.trim());
    current = current.parentElement.closest("li");
  }
  return parts.join("/");
}

const fullPath = buildFullFolderPath(li);
localStorage.setItem("lastFolderPath", fullPath);
console.log("[Folder] Chemin complet enregistr√© :", fullPath);


  const folderName = nameSpan ? nameSpan.textContent.toLowerCase() : "";

  // ‚ö° Gestion sp√©ciale Z3
  if (folderName.includes("tra√ßa_temp") || folderName.includes("traca_temp")) {
    // r√©cup√©rer le dossier parent (= site)
    const siteLi = li.parentElement.closest("li");
    if (siteLi && siteLi.dataset.id) {
      const siblings = await fetchFolderContents(siteLi.dataset.id);
      const hist = siblings.find(s => 
        s.mimeType === 'application/vnd.google-apps.folder' && 
        s.name.toLowerCase().includes("historique")
      );

      if (hist) {
        const histFiles = await fetchFolderContents(hist.id);
        const z3Files = histFiles.filter(ff => 
          ff.name.toUpperCase().startsWith("Z3") && 
          ff.name.toLowerCase().endsWith(".csv")
        );
        localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
        console.log("[Z3] Pr√©charg√©s depuis Historique voisin:", z3Files.length);
      } else {
        localStorage.removeItem("csvZ3Files");
        console.warn("[Z3] Aucun dossier Historique trouv√© pour", nameSpan.textContent);
      }
    }
  } 
  else if (folderName.includes("historique")) {
    // directement charger les Z3 de ce dossier
    const histFiles = await fetchFolderContents(li.dataset.id);
    const z3Files = histFiles.filter(ff => 
      ff.name.toUpperCase().startsWith("Z3") && 
      ff.name.toLowerCase().endsWith(".csv")
    );
    localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
    console.log("[Z3] Pr√©charg√©s directement (Historique):", z3Files.length);
  } 
  else {
    // Sinon ‚Üí effacer le cache Z3
    localStorage.removeItem("csvZ3Files");
    console.log("[Z3] Cache vid√© (hors Tra√ßa_Temp / Historique)");
  }

  // Charger fichiers CSV/JPG classiques du dossier
  const files = await fetchFolderContents(li.dataset.id);
const filtered = files.filter(f =>
  /\.(csv|jpg|jpeg|png|gif|webp|json|pdf|mp4|webm|mov|m4v|avi|ppsx|pptx)$/i.test(f.name)
);








// üß≠ D√©termination du site courant
const siteLi = li.parentElement.closest("li");
let siteId = siteLi?.dataset.id || null;

if (siteId && siteId !== currentSiteId) {
  clearSiteHotDays();
  currentSiteId = siteId;
  console.log(`[SITE] Changement de site ‚Üí ${siteLi.querySelector(".folder-name")?.textContent}`);

// üî• Lancer le scan en arri√®re-plan sans bloquer l'affichage
scanSiteHotDays(siteId).then(map => {
  hotDaysMap = map;
  console.log(`[CACHE] üî• ${Object.keys(hotDaysMap).length} jours chauds d√©tect√©s et charg√©s pour ${siteLi.querySelector(".folder-name")?.textContent}`);

// ü™Ñ Rafra√Æchir seulement les flammes dans le tableau actuel sans supprimer les notes üìù
document.querySelectorAll('#csvTable tbody tr').forEach(tr => {
  const nameCell = tr.cells[3];
  const flameCell = tr.cells[1];
  if (!nameCell || !flameCell) return;

  const fname = nameCell.textContent.trim();
  const m = fname.match(/(\d{8})\.csv$/i);

  // üî• flamme DAY
  if (m && hotDaysMap[m[1]] && !flameCell.innerHTML.includes("üî•")) {
    flameCell.insertAdjacentHTML(
      "afterbegin",
      `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`
    );
  }

  // üìù notes depuis JSON
  if (m && storedNotes[m[1]] && !flameCell.innerHTML.includes("üìù")) {
    flameCell.insertAdjacentHTML(
      "beforeend",
      ` <span class="note" title="${storedNotes[m[1]].join("\n")}">üìù</span>`
      );
    }
  });
});

} else if (siteId && Object.keys(hotDaysMap).length === 0) {
  hotDaysMap = loadSiteHotDays(siteId);
  if (Object.keys(hotDaysMap).length === 0) {
    console.log(`[CACHE] Aucun cache trouv√© pour ${siteLi.querySelector(".folder-name")?.textContent}, relance du scan...`);
    scanSiteHotDays(siteId).then(map => {
      hotDaysMap = map;
      console.log(`[CACHE] üî• ${Object.keys(hotDaysMap).length} jours chauds d√©tect√©s et charg√©s pour ${siteLi.querySelector(".folder-name")?.textContent}`);
      const active = document.querySelector('#folderTree .active-folder');
      if (active) active.click();
    });
  } else {
    console.log(`[CACHE] ${Object.keys(hotDaysMap).length} jours chauds charg√©s depuis cache`);
  }
}

previewFiles = filtered.filter(f => /\.(jpg|jpeg|pdf|mp4|gif|webm|mov|m4v)$/i.test(f.name));

displayFiles(filtered, nameSpan ? nameSpan.textContent : '');



// ü™Ñ Applique imm√©diatement les flammes du cache si d√©j√† charg√© pour ce site
if (Object.keys(hotDaysMap).length > 0) {
  document.querySelectorAll('#csvTable tbody tr').forEach(tr => {
    const nameCell = tr.cells[3]; // colonne Nom du fichier
    const flameCell = tr.cells[1]; // colonne flamme
    if (!nameCell || !flameCell) return;

    const m = nameCell.textContent.match(/(\d{8})\.csv$/i);
    if (m && hotDaysMap[m[1]]) {
      flameCell.innerHTML = `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
    }
  });
}

}

async function displayFiles(files, folderName){

  const tbody=document.querySelector('#csvTable tbody');
  const downloadBtn=document.getElementById('downloadFolderBtn');
  tbody.innerHTML='';


  document.querySelector(".controls").style.display = "flex";

  const gazTasks = []; // ‚úÖ ICI (une seule fois)




  
  // ‚úÖ Afficher les filtres uniquement dans un dossier final (contenant des fichiers)
document.querySelector(".controls").style.display = "flex";


  if(files.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Aucun fichier</td></tr>';
    downloadBtn.style.display="none";
    return;
  }


  downloadBtn.style.display="inline-block";

downloadBtn.style.display="inline-block";

const exportBtn = document.getElementById("exportCsvBtn");
const excelBtn  = document.getElementById("exportExcelGazBtn");



// === Gestion affichage boutons et pastilles GAZ ===
if (folderName.toLowerCase().includes("consommation gaz")) {
  exportBtn.style.display = "inline-block";
  excelBtn.style.display  = "inline-block";

  // --- Cr√©ation des pastilles totales GAZ si absentes ---
  const excelBtnGaz = document.getElementById("exportExcelGazBtn");
  const existingSummary = document.querySelector(".gaz-summary");
  if (excelBtnGaz && !existingSummary) {
    const summaryDiv = document.createElement("div");
    summaryDiv.className = "gaz-summary";
    summaryDiv.innerHTML = `
      <span class="gaz-total gaz-total-m3" title="Total m¬≥ calcul√©">m¬≥ total: --</span>
      <span class="gaz-total gaz-total-kwh" title="Total kWh calcul√©">kWh total: --</span>
    `;
    excelBtnGaz.insertAdjacentElement("afterend", summaryDiv);
  }
} else {
  // --- Masquage des boutons GAZ ---
  exportBtn.style.display = "none";
  excelBtn.style.display  = "none";

  // --- Suppression des pastilles totales GAZ ---
  const existingSummary = document.querySelector(".gaz-summary");
  if (existingSummary) existingSummary.remove();
}




// üîç Pr√©pare la liste des dates ayant un JSON "actif"
const jsonDates = new Set();

await Promise.all(
  files.filter(f => f.name.toLowerCase().endsWith(".json"))
    .map(async (file) => {
      const m = file.name.match(/(\d{8})/);
      if (!m) return;
      const key = m[1];

      try {
        const res = await fetch(
          `https://smes21540.netlify.app/.netlify/functions/drive?id=${file.id}&name=${encodeURIComponent(file.name)}&site=Smes_Acces`
        );
        if (!res.ok) return;

        const text = await res.text();
        const data = JSON.parse(text);

        // JSON attendu sous forme d‚ÄôARRAY
        // On extrait toutes les notes actives
        const notesForDate = data
          .filter(n => n.status?.toLowerCase() === "active")
          .map(n => n.note?.trim())
          .filter(Boolean);

        if (notesForDate.length > 0) {
          storedNotes[key] = notesForDate;
          jsonDates.add(key);
        }

      } catch (err) {
        console.warn("‚ö†Ô∏è JSON mal form√© :", file.name);
      }
    })
);



// ‚ûï Helpers pour ajouter sans √©craser
function addFlame(cell){
  if (!cell.innerHTML.includes("üî•")) {
    cell.innerHTML += (cell.innerHTML ? " " : "") + `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
  }
}
function addNote(cell){
  if (!cell.innerHTML.includes("üìù")) {
    cell.innerHTML += (cell.innerHTML ? " " : "") + `<span class="note" title="Note associ√©e">üìù</span>`;
  }
}




for(const f of files){
    // ‚ùå On n'affiche pas les .json : ils servent juste √† poser üìù
    if (f.name.toLowerCase().endsWith(".json")) continue;

    // Date
    let date='';

    const m=f.name.match(/(\d{8})\.csv$/i);
    if(m){ date=`${m[1].slice(0,4)}-${m[1].slice(4,6)}-${m[1].slice(6,8)}`; }
    else if(/\.(jpg|jpeg)$/i.test(f.name)){
      if(f.modifiedTime) date=f.modifiedTime.slice(0,10);
      else if(f.createdTime) date=f.createdTime.slice(0,10);
    }

    if((filterStartDate && date<filterStartDate) || (filterEndDate && date>filterEndDate)) continue;

const tr=document.createElement('tr');

    const tdFlame = document.createElement('td');
tdFlame.style.textAlign = "center";
tdFlame.style.width = "26px";
tdFlame.textContent = "";



// üî• Application flamme si le fichier correspond √† un jour chaud
const match = f.name.match(/(\d{8})\.csv$/i);
if (match) {
  const dateKey = match[1];

  if (hotDaysMap[dateKey]) {
    addFlame(tdFlame);
  } else {
    setTimeout(() => {
      if (hotDaysMap[dateKey]) addFlame(tdFlame);
    }, 1000);
  }
}

// üìù Ajoute une ic√¥ne si un JSON de la m√™me date est pr√©sent (persiste m√™me apr√®s r√©affichage)
if (match && storedNotes[match[1]]) {
  const txt = storedNotes[match[1]].join("\n");
  tdFlame.innerHTML += ` <span class="note" title="${txt}">üìù</span>`;
}






// Bloc DATE avec affichage du jour
const tdDate=document.createElement('td');
if (date) {
  const d = new Date(date);
  const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const jourNom = jours[d.getDay()];
  tdDate.textContent = `${date} ${jourNom}`;

  // Week-end ‚Üí rouge + gras
  if (d.getDay() === 0 || d.getDay() === 6) {
    tdDate.style.color = "var(--danger)";
    tdDate.style.fontWeight = "bold";
  }
} else {
  tdDate.textContent = '';
}

const tdName = document.createElement('td');
tdName.textContent = f.name;

// === FLAMME FILE (avec cancelScan) ===
if (f.name.toLowerCase().endsWith(".csv") &&
    (folderName.toLowerCase().includes("tra√ßa_temp") || folderName.toLowerCase().includes("traca_temp"))) {

  // Message provisoire
  tdName.innerHTML = `${f.name}&nbsp;&nbsp;&nbsp;<span style="color:gray;font-size:11px;">(scan en cours...)</span>`;

  (async () => {
    try {
      if (cancelScan) { tdName.innerHTML = f.name; return; } // üõë stop si demand√©

      const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`;

      const res = await fetch(url);
      if (!res.ok) { tdName.innerHTML = f.name; return; }

      const text = await res.text();
      if (cancelScan) { tdName.innerHTML = f.name; return; } // üõë stop si demand√©

      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) { tdName.innerHTML = f.name; return; }

      const headers = lines[0].split(",").map(h => h.replace(/"/g,"").trim().toLowerCase());
      let idxInf = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac inf"))[1]?.i;
      let idxSup = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac sup"))[1]?.i;

      if (idxInf === undefined && idxSup === undefined) { tdName.innerHTML = f.name; return; }

      let countFlame = 0;
for (let i = 1; i < lines.length; i++) {
  const cols = lines[i].split(",").map(c => c.replace(/"/g,"").trim());

  // üïî V√©rifie l‚Äôheure (colonne 0 suppos√©e √™tre l‚Äôheure du point)
  const timeStr = cols[0];
  if (timeStr && /^(\d{2}):(\d{2})/.test(timeStr)) {
    const [_, hh, mm] = timeStr.match(/^(\d{2}):(\d{2})/);
    const hour = parseInt(hh, 10);

    // ‚è∞ Ignore les valeurs avant 5h ou apr√®s 23h59
    if (hour < 5 || hour >= 24) continue;
  }

  const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;
  const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;

if (
    (isFinite(vInf) && vInf > 40 && vInf < 300) ||
    (isFinite(vSup) && vSup > 40 && vSup < 300)
) {
    countFlame++;
}

}


if (countFlame >= 1) {
  // üî• Ajoute la flamme tout en pr√©servant la note existante
  const hadNote = tdFlame.innerHTML.includes("üìù");
if (!tdFlame.innerHTML.includes("üî•")) {
  tdFlame.insertAdjacentHTML(
    "afterbegin",
    `<span class="flame" title="Br√ªleur actif d√©tect√© ce jour !">üî•</span>`
  );
}
if (hadNote && !tdFlame.innerHTML.includes("üìù")) {
  tdFlame.insertAdjacentHTML(
    "beforeend",
    ` <span class="note" title="Note associ√©e">üìù</span>`
  );
}

}


// üìù Si un JSON de la m√™me date existe ‚Üí conserver m√™me si scan flamme r√©√©crit
const mNote = f.name.match(/(\d{8})\.csv$/i);
if (mNote && jsonDates.has(mNote[1])) {
  if (!tdFlame.innerHTML.includes("üìù")) addNote(tdFlame);
  tdFlame.dataset.hasNote = "true";
}


tdName.textContent = f.name;


    } catch(e) {
      console.error("Erreur flamme fichier:", f.name, e);
      tdName.innerHTML = f.name;
    }
  })();
}
// === FIN FLAMME FILE ===



const tdFolder=document.createElement('td'); tdFolder.textContent=folderName;

    const tdSize = document.createElement('td');
    if (f.size) {
      tdSize.textContent = formatSize(f.size);
      if (parseInt(f.size) < 200) {
        tdSize.style.color = "#999";
        tdSize.textContent += " (vide)";
      } else {
        tdSize.style.color = "inherit";
      }
    } else {
      tdSize.textContent = '?';
    }

    const tdAction=document.createElement('td'); tdAction.className='action-cell';
    let html='';
if(f.name.toLowerCase().endsWith('.csv')){
  html+=`<a href="https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&download=1&site=Smes_Acces" target="_blank">
          <button class="action-btn">T√©l√©charger</button>
        </a>`;
  html+=`<button class="action-btn" onclick="openViewer('viewer.html','${f.id}','${f.name}')">Tableau</button>`;

  // üëá bouton Courbes seulement si on n'est PAS dans Historique
  if (!folderName.toLowerCase().includes("historique")) {
    html+=`<button class="action-btn" onclick="openViewer('viewer02.html','${f.id}','${f.name}')">Courbes</button>`;
  }

  // üëá bouton Sondes uniquement si on est dans Tra√ßa_Temp
  if (folderName.toLowerCase().includes("tra√ßa_temp") || folderName.toLowerCase().includes("traca_temp")) {
    html+=`<button class="action-btn" onclick="openViewer('index03.html','${f.id}','${f.name}')">Sondes</button>`;
  }
}





// === CONSOMMATION GAZ : placeholders + queue task ===
if (
  ENABLE_GAZ_CALC &&
  folderName.toLowerCase().includes("consommation gaz") &&
  f.name.toLowerCase().endsWith(".csv")
) {
  // üü° Groupe de 4 boutons d'affichage (placeholders)
  html += `
    <div class="gaz-group">
      <button class="gaz-btn" title="kWh consomm√©s sur la journ√©e" disabled>‚è≥ kWh...</button>
      <button class="gaz-btn" title="m¬≥ consomm√©s sur la journ√©e" disabled>m¬≥...</button>
      <button class="gaz-btn" title="Dur√©e de fonctionnement br√ªleur(s)" disabled>‚è± Temps...</button>
      <button class="gaz-btn gaz-small" title="Consommation moyenne sur la journ√©e" disabled>--</button>
    </div>
  `;

  // ‚úÖ on calcule APR√àS que la ligne est dans le DOM
  gazTasks.push({ f, tdAction, tr, tdDate });
}




      










if(/\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)){
  html+=`<img src="https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces"
    onclick="openModal('${f.id}')"
    alt="aper√ßu">`;

  html+=`<a href="https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&download=1&site=Smes_Acces" target="_blank">
          <button class="action-btn">T√©l√©charger</button>
        </a>`;
}


/* ‚úÖ VIDEO (MP4/WEBM/MOV/M4V) */
if(/\.(mp4|webm|mov|m4v)$/i.test(f.name)){
  html += `
    <button class="action-btn" onclick="openModal('${f.id}')">Ouvrir</button>
    <a href="https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&download=1&site=Smes_Acces" target="_blank">
      <button class="action-btn">T√©l√©charger</button>
    </a>
  `;
}



// === PDF ===
if (f.name.toLowerCase().endsWith(".pdf")) {
  html += `
    <a href="https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&download=1&site=Smes_Acces" target="_blank">
      <button class="action-btn">T√©l√©charger</button>
    </a>
    <button class="action-btn" onclick="openModal('${f.id}')">Ouvrir</button>

  `;
}

// === PowerPoint (ppsx/pptx) ===
if (/\.(ppsx|pptx)$/i.test(f.name)) {
  const baseUrl = `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`;

  html += `
    <a href="${baseUrl}&download=1" target="_blank">
      <button class="action-btn">T√©l√©charger</button>
    </a>
    <a href="${baseUrl}" target="_blank">
      <button class="action-btn">Ouvrir</button>
    </a>
  `;
}


  


    tdAction.innerHTML=html;


tr.appendChild(tdDate);
    tr.appendChild(tdFlame);
tr.appendChild(tdAction);
tr.appendChild(tdName);
tr.appendChild(tdFolder);
tr.appendChild(tdSize);


    tbody.appendChild(tr);
  }

// ‚úÖ Lancer les calculs gaz avec limite de concurrence
if (gazTasks.length) {
  await runWithConcurrency(gazTasks, 6, computeGazForRow);
  updateGazTotals();


  
}
}




  
/* ----------- Open viewer (CSV list + index) ----------- */
async function openViewer(viewer, id, name){
  cancelScan = true; // üõë stoppe imm√©diatement tous les scans

  const active = document.querySelector('#folderTree .active-folder');
  if (!active) { alert("S√©lectionnez un dossier !"); return; }

  const folderId = localStorage.getItem('lastFolderId');

  // üìÇ Charger tous les fichiers du dossier courant
  const files = await fetchFolderContents(folderId);

  // üß© S√©parer les fichiers CSV et JSON
  const saFiles = files.filter(f =>
    f.name.toUpperCase().startsWith("SA") &&
    f.name.toLowerCase().endsWith(".csv")
  );
  const jsonFiles = files.filter(f =>
    f.name.toLowerCase().endsWith(".json")
  );

  // üîó R√©cup√©rer les Z3 pr√©charg√©s
  const z3Files = JSON.parse(localStorage.getItem("csvZ3Files") || "[]");

  // üóíÔ∏è Ajouter les fichiers .json dans le cache
  if (jsonFiles.length > 0) {
    console.log(`[Notes] ${jsonFiles.length} fichiers .json ajout√©s au cache`);
    jsonFiles.forEach(jf => {
      if (!jf.parents) jf.parents = [folderId];
      if (!jf.mimeType) jf.mimeType = "application/json";
    });
  }

  // üß† Fusionner le tout
  const allCsv = [...saFiles, ...z3Files, ...jsonFiles];

  function addFolderHierarchy(li, acc){
    if (!li) return;
    const nameSpan = li.querySelector('.folder-name');
    const folderObj = { id: li.dataset.id, name: nameSpan ? nameSpan.textContent : '', parents: [] };
    const parentLi = li.parentElement.closest('li');
    if (parentLi) {
      folderObj.parents.push(parentLi.dataset.id);
      addFolderHierarchy(parentLi, acc);
    }
    if (!acc.find(x => x.id === folderObj.id)) {
      acc.push(folderObj);
    }
  }

  const activeLi = active.closest('li');
  addFolderHierarchy(activeLi, allCsv);
  allCsv.forEach(f => {
    if (!f.parents) f.parents = [];
    if (!f.parents.includes(activeLi.dataset.id)) {
      f.parents.push(activeLi.dataset.id);
    }
  });

  localStorage.setItem("csvFilesList", JSON.stringify(allCsv));
  const index = allCsv.findIndex(f => f.id === id);
  localStorage.setItem("csvFileIndex", index);

  // üîç V√©rifier plan_sondes.csv
  const planFile = files.find(f => f.name.toLowerCase() === "plan_sondes.csv");
  let url = `${viewer}?fileId=${id}&fileName=${encodeURIComponent(name)}`;

const folderPath = localStorage.getItem("lastFolderPath") || "";
url += `&folderPath=${encodeURIComponent(folderPath)}`;
console.log("[Viewer] Dossier ajout√© √† l‚ÄôURL :", folderPath);
  // üîπ Sauvegarde explicite du chemin pour le viewer02
localStorage.setItem("currentFolderPath", folderPath);



  if (planFile) {
    try {
      const respPlan = await fetch(`https://smes21540.netlify.app/.netlify/functions/drive?id=${planFile.id}&name=${encodeURIComponent(planFile.name)}&site=Smes_Acces`);
      const textPlan = await respPlan.text();
      localStorage.setItem("planSondes", textPlan);
    } catch (e) {
      console.error("‚ùå Erreur lors du chargement du plan_sondes.csv", e);
    }
  } else {
    localStorage.removeItem("planSondes");
  }




  window.open(url,'_blank');
  setTimeout(() => { cancelScan = false; }, 1000);
}




/* ----------- Filtres ----------- */
function applyFilter(){
  filterStartDate=document.getElementById('startDate').value;
  filterEndDate=document.getElementById('endDate').value;
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}
function clearFilter(){
  filterStartDate=''; filterEndDate='';
  document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}

function getPreviewType(fileName){
  return /\.pdf$/i.test(fileName) ? "pdf" : "image";
}


  
/* ----------- Modale images / pdf / video + navigation ----------- */

function openModal(id) {
  currentPreviewIndex = previewFiles.findIndex(f => f.id === id);
  const file = previewFiles[currentPreviewIndex];
  if (!file) return; // ‚úÖ n'ouvre pas une modale vide

  const modal = document.getElementById('imageModal');
  modal.style.display = 'flex';

  const frame = document.getElementById('modalFrame');
  const video = document.getElementById('modalVideo');
  const img   = document.getElementById('modalImg');


  const url =
    `https://smes21540.netlify.app/.netlify/functions/drive` +
    `?id=${id}&name=${encodeURIComponent(file.name)}&site=Smes_Acces`;

  const isVideo = /\.(mp4|webm|mov|m4v)$/i.test(file.name);
  const isPdf   = /\.pdf$/i.test(file.name);
  const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);

  // üîÑ Reset complet
  frame.style.display = "none";
  frame.src = "";

  video.pause();
  video.style.display = "none";
  video.src = "";

  img.style.display = "none";
  img.src = "";

  // üéØ Affichage selon type
  if (isVideo) {

    video.style.display = "block";
    video.src = url;
    video.load();

  } else if (isPdf) {

    frame.style.display = "block";
    frame.src = url;

  } else if (isImage) {

    img.style.display = "block";
    img.src = url;

  } else {

    // fallback
    frame.style.display = "block";
    frame.src = url;
  }

  // ‚¨áÔ∏è Bouton t√©l√©chargement
  document.getElementById('downloadBtn').onclick = () => {
    window.open(
      `https://smes21540.netlify.app/.netlify/functions/drive` +
      `?id=${id}&name=${encodeURIComponent(file.name)}` +
      `&download=1&site=Smes_Acces`,
      '_blank'
    );
  };
}


/* ----------- Fermeture modale ----------- */

function closeModal(){

  const modal = document.getElementById('imageModal');
  modal.style.display = 'none';

  const frame = document.getElementById('modalFrame');
  const video = document.getElementById('modalVideo');
  const img   = document.getElementById('modalImg');

  // stop + nettoyage
  frame.src = "";

  video.pause();
  video.src = "";
  video.style.display = "none";

  img.src = "";
  img.style.display = "none";
}


/* ----------- Boutons navigation ----------- */

document.getElementById('prevBtn').onclick = () => {
  if (currentPreviewIndex > 0) {
    openModal(previewFiles[--currentPreviewIndex].id);
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (currentPreviewIndex < previewFiles.length - 1) {
    openModal(previewFiles[++currentPreviewIndex].id);
  }
};


/* ----------- Click hors contenu = fermer ----------- */

window.addEventListener('click', e => {
  const modal = document.getElementById('imageModal');
  if (e.target === modal) closeModal();
});


/* ----------- Navigation clavier ----------- */

window.addEventListener('keydown', e => {

  const modal = document.getElementById('imageModal');
  if (modal.style.display !== 'flex') return;

  if (e.key === 'ArrowLeft' && currentPreviewIndex > 0) {
    openModal(previewFiles[--currentPreviewIndex].id);
  }

  if (e.key === 'ArrowRight' && currentPreviewIndex < previewFiles.length - 1) {
    openModal(previewFiles[++currentPreviewIndex].id);
  }

  if (e.key === 'Escape') {
    closeModal();
  }
});



/* ----------- ZIP overlay + progression + annulation ----------- */
const zipOverlay=document.getElementById('zipOverlay');
const zipProgress=document.getElementById('zipProgress');
const zipCounter=document.getElementById('zipCounter');
const zipFileName=document.getElementById('zipFileName');
const zipTime=document.getElementById('zipTime');
const zipClose=document.getElementById('zipClose');
let zipCancelled=false, zipStartTime=0;

function sanitizeFileName(name){ return name.replace(/[\/\:*?"<>|]/g,"_"); }

function showZipOverlay(name){
  zipCancelled=false;
  zipOverlay.style.display='flex';
  zipFileName.textContent=name;
  zipProgress.style.width='0%';
  zipProgress.textContent='0%';
  zipCounter.textContent='0 / 0 fichiers';
  zipTime.textContent='Temps restant : --';
  zipStartTime=Date.now();
}
function hideZipOverlay(){zipOverlay.style.display='none';}
function updateZipProgress(pct,current,total,sizeAccum){
  zipProgress.style.width=pct+'%';
  zipProgress.textContent=pct+'%';
  zipCounter.textContent=`${current} / ${total} fichiers`;
  if(current>0){
    const elapsed=(Date.now()-zipStartTime)/1000;
    const speedFiles=current/elapsed;
    const speedKB=(sizeAccum/1024)/elapsed;
    const remainingFiles=total-current;
    const remainingTime=remainingFiles/Math.max(speedFiles,0.0001);
    const mins=Math.floor(remainingTime/60);
    const secs=Math.round(remainingTime%60);
    zipTime.textContent=`Temps restant : ${mins>0?mins+'m ':''}${secs}s (${speedFiles.toFixed(1)} fichiers/s, ${Math.max(0,speedKB).toFixed(0)} Ko/s)`;
  }
}
zipClose.onclick=()=>{zipCancelled=true;hideZipOverlay();alert("Pr√©paration ZIP annul√©e.");};

document.getElementById('downloadFolderBtn').onclick=async()=>{
  const active=document.querySelector('#folderTree .active-folder');
  if(!active){alert("S√©lectionnez un dossier !"); return;}
  const folderId=localStorage.getItem('lastFolderId');
  const folderName=active.textContent.trim();
  showZipOverlay(folderName+".zip");
  const files=await fetchFolderContents(folderId);
  if(!files||files.length===0){hideZipOverlay();alert("Aucun fichier dans ce dossier."); return;}
  const zip=new JSZip(); let count=0; let doneSize=0;
  for(const f of files){
    if(zipCancelled) return;
    try{
const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`;

const res = await fetch(url);

      if(!res.ok) throw new Error('Fetch media failed: '+res.status);
      const blob=await res.blob();
      zip.file(sanitizeFileName(f.name), blob);
      count++; doneSize += f.size ? parseInt(f.size) : 0;
      updateZipProgress(Math.round((count/files.length)*100), count, files.length, doneSize);
    }catch(e){console.error("Erreur sur",f.name,e);}
  }
  if(zipCancelled) return;
  const content=await zip.generateAsync({type:"blob"});
  saveAs(content, folderName+".zip");
  hideZipOverlay();
};

/* ----------- Tri tableau + recolorisation ----------- */
let currentSort = { col: null, asc: true };

function sortTable(colIndex, type) {
  const table = document.getElementById("csvTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll("tr"));

  if (currentSort.col === colIndex) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort.col = colIndex;
    currentSort.asc = true;
  }

  rows.sort((a, b) => {
    let aText = a.cells[colIndex]?.textContent.trim() || "";
    let bText = b.cells[colIndex]?.textContent.trim() || "";
    if (type === "number") {
      aText = parseFloat(aText) || 0;
      bText = parseFloat(bText) || 0;
    } else if (type === "date") {
      aText = new Date(aText).getTime() || 0;
      bText = new Date(bText).getTime() || 0;
    }
    if (aText < bText) return currentSort.asc ? -1 : 1;
    if (aText > bText) return currentSort.asc ? 1 : -1;
    return 0;
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));

  // mise √† jour des fl√®ches
  document.querySelectorAll("thead th .sort-arrow").forEach(span => span.textContent = "");
  const arrow = table.tHead.rows[0].cells[colIndex].querySelector(".sort-arrow");
  if (arrow) arrow.textContent = currentSort.asc ? "‚ñ≤" : "‚ñº";
}


/* ----------- Menu secret (th√®mes) ----------- */
document.getElementById("secretBtn").onclick=()=>{
  const menu=document.getElementById("themeMenu");
  if(menu.style.display==="block"){ closeThemeMenu(); }
  else { menu.style.display="block"; resetThemeMenuTimer(); }
};
function resetThemeMenuTimer(){ clearTimeout(themeMenuTimer); themeMenuTimer=setTimeout(closeThemeMenu,10000); }
function closeThemeMenu(){ document.getElementById("themeMenu").style.display="none"; clearTimeout(themeMenuTimer); }

/* ----------- Th√®mes + persistance (+ lignes du tableau) ----------- */
function setTheme(theme){
  document.body.setAttribute("data-theme", theme);
  const r=document.documentElement;
  const logo=document.getElementById("mainLogo");
  logo.style.display=(theme==="orange")?"block":"none";
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange"){
    r.style.setProperty("--accent","#ff7043");
    r.style.setProperty("--accent-darker","#e64a19");
    r.style.setProperty("--accent-muted","#ffccbc");
    r.style.setProperty("--bg","#fff5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#ffe5d9");
    r.style.setProperty("--danger","#d84315");
    r.style.setProperty("--text","#333");
    r.style.setProperty("--row-even","#ffe5d9");
    r.style.setProperty("--row-odd","#fff5f5");
  }
  if(theme==="blue"){
    r.style.setProperty("--accent","#2196f3");
    r.style.setProperty("--accent-darker","#1976d2");
    r.style.setProperty("--accent-muted","#bbdefb");
    r.style.setProperty("--bg","#e3f2fd");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#bbdefb");
    r.style.setProperty("--danger","#0d47a1");
    r.style.setProperty("--text","#0d47a1");
    r.style.setProperty("--row-even","#bbdefb");
    r.style.setProperty("--row-odd","#e3f2fd");
  }
  if(theme==="green"){
    r.style.setProperty("--accent","#4caf50");
    r.style.setProperty("--accent-darker","#2e7d32");
    r.style.setProperty("--accent-muted","#c8e6c9");
    r.style.setProperty("--bg","#f1f8e9");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#c8e6c9");
    r.style.setProperty("--danger","#1b5e20");
    r.style.setProperty("--text","#1b5e20");
    r.style.setProperty("--row-even","#c8e6c9");
    r.style.setProperty("--row-odd","#f1f8e9");
  }
  if(theme==="purple"){
    r.style.setProperty("--accent","#9c27b0");
    r.style.setProperty("--accent-darker","#6a1b9a");
    r.style.setProperty("--accent-muted","#e1bee7");
    r.style.setProperty("--bg","#f3e5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#e1bee7");
    r.style.setProperty("--danger","#4a148c");
    r.style.setProperty("--text","#4a148c");
    r.style.setProperty("--row-even","#e1bee7");
    r.style.setProperty("--row-odd","#f3e5f5");
  }
  if(theme==="bordeaux"){
    r.style.setProperty("--accent","#800020");
    r.style.setProperty("--accent-darker","#4b0014");
    r.style.setProperty("--accent-muted","#d7a1a9");
    r.style.setProperty("--bg","#fff0f2");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#f3cdd3");
    r.style.setProperty("--danger","#600018");
    r.style.setProperty("--text","#4b0014");
    r.style.setProperty("--row-even","#f3cdd3");
    r.style.setProperty("--row-odd","#fff0f2");
  }
}

/* ----------- üî• Gestion des jours chauds par site ----------- */
const FLAME_MIN_LINES = 5;
let currentSiteId = null;
let hotDaysMap = {}; // { 'YYYYMMDD': true }

async function scanSiteHotDays(siteId) {
  const hotDays = {};
  console.time(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
  console.log(`[SCAN] Scan du site ${siteId} ‚Üí dossier Tra√ßa_Temp`);

  try {
    const siblings = await fetchFolderContents(siteId);
    const tracatemp = siblings.find(s => 
      s.mimeType === 'application/vnd.google-apps.folder' &&
      (s.name.toLowerCase().includes("tra√ßa_temp") || s.name.toLowerCase().includes("traca_temp"))
    );
if (!tracatemp) {
  console.warn(`[SCAN] Aucun dossier Tra√ßa_Temp trouv√© pour le site ${siteId}`);
  return hotDays;
}


    const files = await fetchFolderContents(tracatemp.id);
    const csvFiles = files.filter(f => f.name.toLowerCase().endsWith(".csv"));
    console.log(`[SCAN] ${csvFiles.length} CSV trouv√©s dans ${tracatemp.name}`);

    for (const f of csvFiles) {
      try {
        const res = await fetch(
          `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`
        );
        if (!res.ok) continue;

        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (lines.length < 2) continue;

        const headers = lines[0].split(",").map(h => h.replace(/"/g, "").trim().toLowerCase());

        // üîç 2√®me occurrence (comme ton ancien index)
        let idxInf = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac inf"))[1]?.i;
        let idxSup = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac sup"))[1]?.i;
        if (idxInf === undefined && idxSup === undefined) continue;

        let countFlame = 0;
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",").map(c => c.replace(/"/g, "").trim());

          // üïî ignore la nuit (<5h)
          const timeStr = cols[0];
          if (timeStr && /^(\d{2}):(\d{2})/.test(timeStr)) {
            const [_, hh] = timeStr.match(/^(\d{2}):/);
            const hour = parseInt(hh, 10);
            if (hour < 5) continue;
          }

          const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;
          const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;

if (
    (isFinite(vInf) && vInf > 40 && vInf < 300) ||
    (isFinite(vSup) && vSup > 40 && vSup < 300)
) {
    countFlame++;
}

        }

        if (countFlame >= 1) {
          const m = f.name.match(/(\d{8})\.csv$/i);
          if (m) hotDays[m[1]] = true;
        }

      } catch (e) {
        console.warn(`[SCAN] Erreur lecture fichier ${f.name}:`, e);
      }
    }

console.log(`[SCAN] üî• ${Object.keys(hotDays).length} jours chauds d√©tect√©s pour le site`);
console.timeEnd(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
localStorage.setItem(`hotDays_${siteId}`, JSON.stringify(hotDays));

// ‚úÖ Recharge les calendriers maintenant que hotDaysMap est pr√™t
initDatePickers();

return hotDays;


  } catch (err) {
    console.error("[SCAN] Erreur g√©n√©rale scanSiteHotDays:", err);
    console.timeEnd(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
    return hotDays;
  }
}


function loadSiteHotDays(siteId) {
  const data = localStorage.getItem(`hotDays_${siteId}`);
  return data ? JSON.parse(data) : {};
}


function clearSiteHotDays() {
  if (currentSiteId) {
    localStorage.removeItem(`hotDays_${currentSiteId}`);
  }
  hotDaysMap = {};
  currentSiteId = null;
}




/* ----------- üî• V√©rif CSV du jour pour "Temp" ----------- */
async function checkTra√ßaTempToday(parentLi, tracatempId) {
  const today = new Date();
  const yyyymmdd =
    today.getFullYear().toString() +
    String(today.getMonth() + 1).padStart(2, "0") +
    String(today.getDate()).padStart(2, "0");

  const files = await fetchFolderContents(tracatempId);
  // accepter tout CSV contenant la date du jour
  const todayFile = files.find(f => f.name.includes(yyyymmdd) && f.name.endsWith(".csv"));
  if (!todayFile) return;

  try {
const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${todayFile.id}&name=${encodeURIComponent(todayFile.name)}&t=${Date.now()}&site=Smes_Acces`;

const res = await fetch(url);

    const text = await res.text();

    // lire les derni√®res lignes
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    const lastLine = lines[lines.length - 1];
    if (!lastLine) return;

    // Nettoyage : enlever guillemets et espaces
    const headers = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    const cols = lastLine.split(",").map(c => c.replace(/"/g, "").trim());

    // Trouver la 2√®me occurrence de "Sonde AC Sup"
    let supIndices = headers
      .map((h, i) => ({ h, i }))
      .filter(o => o.h.toLowerCase().includes("sonde ac sup"));
    let idxSup = supIndices.length >= 2 ? supIndices[1].i : supIndices[0]?.i;

    // Trouver la 2√®me occurrence de "Sonde AC Inf"
    let infIndices = headers
      .map((h, i) => ({ h, i }))
      .filter(o => o.h.toLowerCase().includes("sonde ac inf"));
    let idxInf = infIndices.length >= 2 ? infIndices[1].i : infIndices[0]?.i;

    // Valeurs
    const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;
    const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;

    // üî• seuil
    if (
    (isFinite(vSup) && vSup > 40 && vSup < 300) ||
    (isFinite(vInf) && vInf > 40 && vInf < 300)
)
 {
      markFolderWithFlame(parentLi);
    }


  } catch (e) {
    console.error("Erreur lecture CSV dans Temp", e);
  }
}

function markFolderWithFlame(li) {
  if (!li) return; // s√©curit√©

  const span = li.querySelector(".folder-name");
  if (!(span instanceof HTMLElement)) return; // √©vite les erreurs de type

  if (!span.classList.contains("has-flame")) {
    span.classList.add("has-flame");
    span.innerHTML = `<span class="flame-folder" title="Br√ªleur(s) actuellement en fonctionnement">üî•</span> ` + span.innerHTML;
  }

  const parent = li.parentElement?.closest("li");
  if (parent) markFolderWithFlame(parent);
}


/* ----------- Datepickers enrichis (Flatpickr) ----------- */
let fpStart = null;
let fpEnd = null;

function initDatePickers() {
  const commonOpts = {
    dateFormat: "Y-m-d",
    locale: flatpickr.l10ns.fr, // ‚úÖ langue fran√ßaise correcte
    allowInput: true,
    clickOpens: true,

    // üí° D√®s l‚Äôouverture ‚Üí coloration imm√©diate des jours chauds
    onOpen: function(selectedDates, dateStr, instance) {
      recolorHotDays(instance);
    },
    onReady: function(selectedDates, dateStr, instance) {
      recolorHotDays(instance);
    },
    onMonthChange: function(selectedDates, dateStr, instance) {
      recolorHotDays(instance);
    },
    onYearChange: function(selectedDates, dateStr, instance) {
      recolorHotDays(instance);
    },

    onChange: function(selectedDates, dateStr, instance) {
      const parent = instance.input.closest(".date-field");
      if (dateStr) parent.classList.add("has-date");
      else parent.classList.remove("has-date");
    },

onDayCreate: function(dObj, dStr, fp, dayElem) {
  const yyyymmdd = dayElem.dateObj.getFullYear().toString() +
    String(dayElem.dateObj.getMonth() + 1).padStart(2, "0") +
    String(dayElem.dateObj.getDate()).padStart(2, "0");
  if (hotDaysMap && hotDaysMap[yyyymmdd]) {
    dayElem.classList.add("hot-day");
    dayElem.title = "Jour chaud d√©tect√©";
  }
}

  };

  // üîÑ D√©truire les anciens calendriers pour forcer le redraw
  if (fpStart) fpStart.destroy();
  if (fpEnd) fpEnd.destroy();

// üìÖ Ic√¥nes calendrier (plus grandes) + positionnement localis√©
const iconStart = document.getElementById("iconStart");
const iconEnd = document.getElementById("iconEnd");

fpStart = flatpickr("#startDate", {
  ...commonOpts,
  positionElement: iconStart, // üëà s‚Äôaffiche coll√© √† l‚Äôic√¥ne
});
fpEnd = flatpickr("#endDate", {
  ...commonOpts,
  positionElement: iconEnd,   // üëà idem
});

// üìÖ clic sur les ic√¥nes pour ouvrir le calendrier
if (iconStart) iconStart.onclick = () => fpStart.open();
if (iconEnd) iconEnd.onclick = () => fpEnd.open();

}


/* ----------- Coloration des jours chauds ----------- */
function recolorHotDays(instance) {
  const days = instance.calendarContainer.querySelectorAll(".flatpickr-day");
  days.forEach(dayElem => {
    const yyyymmdd = dayElem.dateObj.getFullYear().toString() +
  String(dayElem.dateObj.getMonth() + 1).padStart(2, "0") +
  String(dayElem.dateObj.getDate()).padStart(2, "0");

    if (hotDaysMap && hotDaysMap[yyyymmdd]) {
      dayElem.classList.add("hot-day");
      dayElem.title = "Jour chaud d√©tect√©";
    } else {
      dayElem.classList.remove("hot-day");
      dayElem.removeAttribute("title");
    }
  });
}


/* ----------- Export CSV (Gaz) ----------- */
document.getElementById("exportCsvBtn").addEventListener("click", async function () {

    const rows = Array.from(document.querySelectorAll("#csvTable tbody tr"))
        .filter(r => r.style.display !== "none");

    if (rows.length === 0) {
        alert("Aucune ligne visible √† exporter.");
        return;
    }

    let csv = "Date,ConsokWh,ConsoM3,Duree,DureeMinutes,Moyenne(kWh/h),Tonnage\n";

    for (const row of rows) {

        // --- DATE ---
        let date = row.querySelector("td:nth-child(1)")?.textContent.split(" ")[0] || "0";
        if (!date) date = "0";

        const btns = row.querySelectorAll(".gaz-group .gaz-btn");
        if (btns.length !== 4) continue;

        // --- KWH ---
        let kwh = btns[0].textContent.replace(/[^\d.-]/g, "");
        if (kwh === "" || isNaN(kwh)) kwh = "0";

        // --- M3 ---
        let m3 = btns[1].textContent.replace(/[^\d.-]/g, "");
        if (m3 === "" || isNaN(m3)) m3 = "0";

        // --- DUREE (HH:MM) ---
        let duree = btns[2].textContent.replace(/[^0-9:]/g, "");
        if (!duree.includes(":")) duree = "0";

        // --- DUREE MINUTES ---
        let mins = 0;
        if (duree !== "0") {
            const p = duree.split(":");
            const h = parseInt(p[0], 10);
            const m = parseInt(p[1], 10);
            mins = (isNaN(h) || isNaN(m)) ? 0 : (h * 60 + m);
        }

        // --- MOYENNE ---
        let avg = btns[3].textContent.replace(/[^\d.-]/g, "");
        if (avg === "" || isNaN(avg)) avg = "0";

let tonnage = 0;
if (row.dataset.tonnage) {
    tonnage = parseFloat(row.dataset.tonnage);
    tonnage = Number(tonnage.toFixed(1)); // üî• arrondi √† 0.1 tonne
}



        csv += `${date},${kwh},${m3},${duree},${mins},${avg},${tonnage}\n`;
    }

// 1Ô∏è‚É£ Sauvegarde du CSV pour viewer02
localStorage.setItem("exportGazCsvData", csv);

// 2Ô∏è‚É£ Ouvre viewer03 en mode courbes
window.open("viewer03.html?export_gaz=1", "_blank");

});


document.getElementById("exportExcelGazBtn").addEventListener("click", function () {

    const rows = Array.from(document.querySelectorAll("#csvTable tbody tr"))
        .filter(r => r.style.display !== "none");

    if (rows.length === 0) {
        alert("Aucune ligne visible √† exporter.");
        return;
    }

    const data = [];
    data.push([
        "Date",
        "kWh consomm√©s",
        "m¬≥ consomm√©s",
        "Dur√©e (HH:mm)",
        "Dur√©e (minutes)",
        "Moyenne kWh/h",
        "Tonnage"
    ]);

    for (const row of rows) {

        // 1Ô∏è‚É£ Date
        let date = row.querySelector("td:nth-child(1)")?.textContent.split(" ")[0] || "";

        // 2Ô∏è‚É£ Boutons gaz
        const btns = row.querySelectorAll(".gaz-group .gaz-btn");
        if (btns.length !== 4) continue;

        const kwh   = parseFloat(btns[0].textContent.replace(/[^\d.-]/g, "")) || 0;
        const m3    = parseFloat(btns[1].textContent.replace(/[^\d.-]/g, "")) || 0;
        const duree = btns[2].textContent.replace(/[^0-9:]/g, "") || "00:00";
        const avg   = parseFloat(btns[3].textContent.replace(/[^\d.-]/g, "")) || 0;

        let mins = 0;
        if (duree.includes(":")) {
            const [h, m] = duree.split(":");
            mins = (parseInt(h) * 60) + parseInt(m);
        }

        // 3Ô∏è‚É£ Tonnage stock√© par displayFiles()
        let tonnage = parseFloat(row.dataset.tonnage) || 0;
        tonnage = Number(tonnage.toFixed(1));

        data.push([date, kwh, m3, duree, mins, avg, tonnage]);
    }

    // G√©n√©ration Excel
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Consommation Gaz");

    XLSX.writeFile(wb, `export_gaz_${new Date().toISOString().slice(0,10)}.xlsx`);
});



// =========================================
// === Calcule les valeurs GAZ pour une ligne
// =========================================
async function computeGazForRow({ f, tdAction, tr, tdDate }) {
  const res = await fetch(
    `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`
  );
  if (!res.ok) throw new Error("Fetch CSV GAZ failed: " + res.status);

  const text = await res.text();
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

  let diffMinutes = 0;
  let diffKwh = 0;
  let diffM3 = 0;
  let kwhEstime = false;

  if (lines.length > 2) {
    const firstCols = lines[1].split(",");
    const lastCols  = lines[lines.length - 1].split(",");

    // 1) kWh brut
    const kFirst = parseFloat(firstCols[2].replace(/"/g,""));
    const kLast  = parseFloat(lastCols[2].replace(/"/g,""));
    if (isFinite(kFirst) && isFinite(kLast)) diffKwh = kLast - kFirst;

    // 2) m¬≥
    const m3First = parseFloat(firstCols[4].replace(/"/g,""));
    const m3Last  = parseFloat(lastCols[4].replace(/"/g,""));
    if (isFinite(m3First) && isFinite(m3Last)) diffM3 = m3Last - m3First;

    // 3) dur√©e active (minutes)
    let active = 0;
    for (let i = 1; i < lines.length; i++) {
      const prev = lines[i - 1].split(",");
      const curr = lines[i].split(",");
      const kPrev = parseFloat(prev[2].replace(/"/g,""));
      const kCurr = parseFloat(curr[2].replace(/"/g,""));
      if (isFinite(kPrev) && isFinite(kCurr) && kCurr > kPrev) active++;
    }
    diffMinutes = active;
  }

  // R√©cup boutons
  const btns = tdAction.querySelectorAll(".gaz-btn");
  if (btns.length < 4) return;

  const btnKwh    = btns[0];
  const btnM3     = btns[1];
  const btnHeures = btns[2];
  const btnAvg    = btns[3];

  // Si aucune activit√© -> masque
  if ((diffM3 === 0 || !isFinite(diffM3)) && (diffKwh === 0 || !isFinite(diffKwh))) {
    btns.forEach(b => b.style.display = "none");
    return;
  }

  // Affichage m¬≥ + d√©grad√©
  btnM3.textContent = diffM3.toFixed(1) + " m¬≥";
  btnM3.style.minWidth = "125px";
  btnM3.style.color = "#5d4037";

  const minM3 = 1000;
  const maxM3 = 5000;
  let ratio = (diffM3 - minM3) / (maxM3 - minM3);
  ratio = Math.max(0, Math.min(1, ratio));

  const r1 = 255, g1 = 245, b1 = 157;
  const r2 = 255, g2 = 112, b2 = 67;
  const r = Math.round(r1 + (r2 - r1) * ratio);
  const g = Math.round(g1 + (g2 - g1) * ratio);
  const b = Math.round(b1 + (b2 - b1) * ratio);
  const color1 = `rgb(${r},${g},${b})`;
  const color2 = `rgb(${Math.max(r-20,0)},${Math.max(g-20,0)},${Math.max(b-20,0)})`;
  btnM3.style.background = `linear-gradient(180deg, ${color1}, ${color2})`;

  // kWh (avec correction)
  let rounded = Math.round(diffKwh);
  if (rounded < 0 || rounded > 400000) {
    rounded = Math.round(diffM3 * 32.3);
    kwhEstime = true;
  }

  // dur√©e
  const H = String(Math.floor(diffMinutes / 60)).padStart(2,"0");
  const M = String(diffMinutes % 60).padStart(2,"0");
  const dureeFormatee = `${H}:${M}`;

  btnHeures.textContent = `‚è± ${dureeFormatee}`;
  btnHeures.style.background = "linear-gradient(180deg, #bbdefb, #64b5f6)";
  btnHeures.style.color = "#0d47a1";
  btnHeures.style.minWidth = "120px";

  // moyenne kWh/h
  const hours = diffMinutes / 60;
  let avg = 0;
  let moyenneEstimee = false;

  if (hours > 0 && rounded > 0) {
    avg = rounded / hours;
    if (avg < 1000) {
      rounded = Math.round(diffM3 * 32.3);
      avg = rounded / hours;
      moyenneEstimee = true;
      kwhEstime = true;
    }
    btnAvg.textContent = `${avg.toFixed(1)} kWh/h`;
  } else {
    btnAvg.textContent = "--";
  }

  // affichage kWh
  const padded = String(rounded).padStart(7, " ");
  btnKwh.textContent = `${padded} kWh`;
  btnKwh.style.minWidth = "120px";

  if (kwhEstime || moyenneEstimee) {
    btnKwh.style.background = "linear-gradient(180deg, #bbdefb, #42a5f5)";
    btnKwh.style.color = "#0d47a1";
    btnAvg.style.background = "linear-gradient(180deg, #c5cae9, #7986cb)";
    btnAvg.style.color = "#1a237e";
  } else {
    btnKwh.style.background = "linear-gradient(180deg, #ffd54f, #ffb300)";
    btnKwh.style.color = "#3e2723";
    btnAvg.style.background = "linear-gradient(180deg, #e1f5fe, #81d4fa)";
    btnAvg.style.color = "#01579b";
  }

  // TONNAGE (reprend ton code)
  const dateStr = tdDate.textContent.split(" ")[0];
  const fullPath = localStorage.getItem("lastFolderPath") || "";
  const siteRoot = fullPath.split("/")[0];
  let tonnage = await getTonnageForDate(siteRoot, dateStr);
  if (!isFinite(tonnage)) tonnage = 0;
  tr.dataset.tonnage = Number(tonnage.toFixed(1));
}




// === Fonction de cumul global des GAZ ===
function updateGazTotals() {
  const totalM3Span = document.querySelector(".gaz-total-m3");
  const totalKwhSpan = document.querySelector(".gaz-total-kwh");
  if (!totalM3Span || !totalKwhSpan) return; // pas de pastilles visibles

  let totalM3 = 0;
  let totalKwh = 0;

document.querySelectorAll("#csvTable tbody tr").forEach(tr => {
  if (tr.style.display === "none") return;  // ne compte pas les lignes filtr√©es
  const group = tr.querySelector(".gaz-group");
  if (!group) return;

  const btns = group.querySelectorAll(".gaz-btn");
  if (btns.length >= 2) {
    const m3Text = btns[1].textContent.replace(/[^\d.]/g, "");
    const kwhText = btns[0].textContent.replace(/[^\d.]/g, "");
    const m3 = parseFloat(m3Text);
    const kwh = parseFloat(kwhText);
    if (isFinite(m3)) totalM3 += m3;
    if (isFinite(kwh)) totalKwh += kwh;
  }
});


  totalM3Span.textContent = `m¬≥ total: ${totalM3.toFixed(1)}`;
  totalKwhSpan.textContent = `kWh total: ${Math.round(totalKwh).toLocaleString("fr-FR")}`;
}

// === Limiteur de concurrence (√©vite 200 fetch en m√™me temps) ===
async function runWithConcurrency(tasks, limit, worker) {
  let i = 0;
  const executing = new Set();

  async function enqueue() {
    if (i >= tasks.length) return;
    const task = tasks[i++];

    const p = (async () => worker(task))()
      .catch(err => console.warn("[GAZ] task failed:", err))
      .finally(() => executing.delete(p));

    executing.add(p);

    if (executing.size >= limit) {
      await Promise.race(executing);
    }
    await enqueue();
  }

  await enqueue();
  await Promise.all([...executing]);
}

  

/* ----------- Init ----------- */
window.onload=()=>{
  updateNetworkStatus();
  const savedTheme=localStorage.getItem("selectedTheme")||"orange";
  setTheme(savedTheme);

  // bouton "T√©l√©charger le dossier" cach√© par d√©faut tant qu'aucun contenu
  document.getElementById("downloadFolderBtn").style.display="none";

  loadRootFolders();
  initDatePickers();
const last = localStorage.getItem("lastFolderId");
if (last) {
  // attendre un peu que l'arborescence soit rendue
  setTimeout(() => {
    const li = document.querySelector(`#folderTree li[data-id="${last}"]`);
    if (li) {
      loadFolderFilesOnClick(li);
    } else {
      console.warn("[INIT] Impossible de retrouver le dernier dossier ouvert :", last);
    }
  }, 1200);
}

};


</script>

<!-- === Fonction de nettoyage du cache === -->
<script>
function clearBrowserCache() {
  if (confirm('üßΩ Vider le cache local du navigateur ?')) {
    try {
      localStorage.clear();
      sessionStorage.clear();

      if ('caches' in window) {
        caches.keys().then(names => {
          for (let name of names) caches.delete(name);
        });
      }

      alert('‚úÖ Cache local vid√©.\nLa page va √™tre recharg√©e.');
      location.reload(true);
    } catch (err) {
      console.error('Erreur pendant le nettoyage du cache :', err);
      alert('Erreur pendant le nettoyage du cache.');
    }
  }
}
</script>








</body>
</html>
























































